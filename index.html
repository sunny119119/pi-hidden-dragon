<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pi Â· ä¹¾å¤é¾™è—</title>
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
    <style>
        body { background-color: #0c0c0c; color: #dcdde1; font-family: 'Microsoft YaHei', sans-serif; margin: 0; overflow: hidden; display: flex; flex-direction: column; align-items: center; height: 100vh; user-select: none; }
        #loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: #000; z-index: 999; display: flex; justify-content: center; align-items: center; flex-direction: column; color: #f1c40f; }
        .btn-pi { border: 1px solid #f1c40f; background: #f1c40f; color: #000; padding: 10px 30px; font-size: 18px; border-radius: 8px; font-weight: bold; margin: 10px; cursor: pointer; }
        .btn-skip { border: 1px solid #555; background: transparent; color: #888; padding: 8px 20px; font-size: 14px; border-radius: 8px; margin-top: 20px; }
        
        /* æ¸¸æˆåŸæœ‰æ ·å¼ */
        .bagua-bg { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 300px; color: rgba(50, 50, 50, 0.1); z-index: -1; pointer-events: none; animation: spin 60s linear infinite; }
        @keyframes spin { 100% { transform: translate(-50%, -50%) rotate(360deg); } }
        #top-bar { width: 90%; display: flex; justify-content: space-between; align-items: center; margin-top: 10px; z-index: 10; }
        #header { font-size: 22px; font-weight: bold; text-shadow: 0 0 8px rgba(255, 255, 255, 0.3); }
        #lang-btn { background: transparent; border: 1px solid #7f8c8d; color: #bdc3c7; padding: 4px 10px; border-radius: 15px; font-size: 12px; }
        #ui-bar { width: 90%; margin-top: 15px; padding: 10px; background: rgba(30, 30, 30, 0.8); border: 1px solid #555; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .stat-item { display: flex; flex-direction: column; align-items: center; font-size: 12px; color: #aaa; }
        .stat-val { font-size: 16px; font-weight: bold; margin-top: 2px; color: #fff; }
        #destiny-box { border: 1px solid #f1c40f; padding: 5px 10px; border-radius: 4px; color: #f1c40f; text-align: center; }
        #game-canvas { margin-top: 20px; background-color: #000; border: 2px solid #333; box-shadow: 0 0 20px rgba(0, 0, 0, 0.8); touch-action: none; }
        #message-box { position: absolute; bottom: 80px; width: 80%; text-align: center; background: rgba(10, 10, 10, 0.95); border: 1px solid #fff; padding: 12px; display: none; border-radius: 6px; font-size: 14px; line-height: 1.6; z-index: 20; animation: fadeIn 0.3s; }
        #controls { position: absolute; bottom: 20px; font-size: 12px; color: #666; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <!-- åŠ è½½ä¸ç™»å½•å±‚ -->
    <div id="loading-overlay">
        <div style="margin-bottom: 20px; font-size: 24px;">ä¹¾å¤ Â· é¾™è—</div>
        <div id="status-text" style="margin-bottom: 30px; font-size: 14px; color:#aaa;">å‡†å¤‡å°±ç»ª</div>
        
        <!-- æ‰‹åŠ¨ç‚¹å‡»ç™»å½•ï¼Œé˜²æ­¢è¢«æ‹¦æˆª -->
        <button class="btn-pi" onclick="startPiLogin()">Login with Pi</button>
        
        <!-- è·³è¿‡æŒ‰é’® -->
        <button class="btn-skip" onclick="skipLogin()">è·³è¿‡ç™»å½• (å•æœºç‰ˆ)</button>
    </div>

    <!-- æ¸¸æˆä¸»ç•Œé¢ -->
    <div class="bagua-bg">â˜¯</div>
    <div id="top-bar">
        <div id="header">ä¹¾å¤ Â· é¾™è—</div>
        <button id="lang-btn" onclick="toggleLanguage()">ğŸŒ ä¸­/EN</button>
    </div>
    <div id="ui-bar">
        <div class="stat-item"><span>æ°” (Chi)</span><span class="stat-val" id="energy">10</span></div>
        <div id="destiny-box" onclick="rerollDestiny()">
            <div style="font-size:10px;">æœ¬å‘½ (Destiny)</div>
            <div id="my-element" style="font-size:18px;">ğŸ”¥ ç«</div>
        </div>
        <div class="stat-item"><span>Pi (Treasure)</span><span class="stat-val" id="balance" style="color:#f1c40f">0.00</span></div>
    </div>
    <canvas id="game-canvas"></canvas>
    <div id="message-box"></div>
    <div id="controls"><span id="username-display">é“å‹è¯·ç•™æ­¥</span> | ç‚¹å‡»æ¢ç´¢ Â· äº”è¡Œç”Ÿå…‹</div>

    <script>
        const Pi = window.Pi;
        
        // 1. æ‰‹åŠ¨è§¦å‘ç™»å½•å‡½æ•°
               // --- è°ƒè¯•ç‰ˆç™»å½•å‡½æ•° (å¼€å§‹) ---
        async function startPiLogin() {
            const status = document.getElementById('status-text');
            
            // ã€ç¬¬ä¸€æ­¥ã€‘å¼¹çª—æ˜¾ç¤ºå½“å‰çœŸå®ç½‘å€
            // Pi SDK è¦æ±‚åå°é…ç½®çš„ URL å¿…é¡»å’Œä¸‹é¢å¼¹å‡ºçš„è¿™ä¸ªä¸€æ¨¡ä¸€æ ·ï¼
            const currentUrl = window.location.href;
            alert("ğŸ” æ­£åœ¨è¯Šæ–­...\n\næµè§ˆå™¨å½“å‰çš„çœŸå®ç½‘å€æ˜¯ï¼š\n" + currentUrl + "\n\nè¯·æ£€æŸ¥ï¼šPiåå°å¡«å†™çš„URLå¿…é¡»å’Œä¸Šé¢è¿™ä¸ªå®Œå…¨ä¸€è‡´(åŒ…æ‹¬æœ«å°¾æ–œæ )ï¼");

            try {
                status.innerText = "æ­£åœ¨åˆå§‹åŒ– SDK...";
                Pi.init({ version: "2.0", sandbox: true });
                
                status.innerText = "æ­£åœ¨å‘¼å« Pi é’±åŒ…...";
                const scopes = ['username', 'payments'];
                
                // å¼€å§‹è®¤è¯
                const auth = await Pi.authenticate(scopes, onIncompletePaymentFound);
                
                // å¦‚æœæˆåŠŸ
                status.innerText = "ç™»å½•æˆåŠŸï¼";
                document.getElementById('username-display').innerText = `é“å‹ @${auth.user.username}`;
                
                setTimeout(() => {
                    document.getElementById('loading-overlay').style.display = 'none';
                    init();
                    showMessage(`æ¬¢è¿ @${auth.user.username}`, "#f1c40f");
                }, 500);

            } catch (err) {
                console.error(err);
                status.innerText = "é”™è¯¯: " + err;
                // å¦‚æœæŠ¥é”™ï¼Œä¹Ÿä¼šå¼¹çª—æç¤ºå…·ä½“åŸå› 
                alert("âŒ ç™»å½•å¤±è´¥ï¼é”™è¯¯ä¿¡æ¯ï¼š\n" + err);
            }
        }
        // --- è°ƒè¯•ç‰ˆç™»å½•å‡½æ•° (ç»“æŸ) ---
                // ç™»å½•æˆåŠŸåè¿›å…¥æ¸¸æˆ
                setTimeout(() => {
                    document.getElementById('loading-overlay').style.display = 'none';
                    init();
                    showMessage(`æ¬¢è¿ @${auth.user.username}`, "#f1c40f");
                }, 500);

            } catch (err) {
                console.error(err);
                status.innerText = "ç™»å½•å¤±è´¥: " + err;
                alert("Pi ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘å€é…ç½®æ˜¯å¦æ­£ç¡®ã€‚\né”™è¯¯ä¿¡æ¯: " + err);
            }
        }

        function onIncompletePaymentFound(payment) {}

        function skipLogin() {
            document.getElementById('loading-overlay').style.display = 'none';
            init();
            showMessage("å•æœºæ¼”ç»ƒæ¨¡å¼", "#aaa");
        }

        // --- æ¸¸æˆæ ¸å¿ƒé€»è¾‘ (ä¿æŒä¸å˜) ---
        const WUXING = {'Metal':{name:'é‡‘',color:'#f1c40f',icon:'âšª'},'Wood':{name:'æœ¨',color:'#2ecc71',icon:'ğŸŒ²'},'Water':{name:'æ°´',color:'#3498db',icon:'ğŸ’§'},'Fire':{name:'ç«',color:'#e74c3c',icon:'ğŸ”¥'},'Earth':{name:'åœŸ',color:'#d35400',icon:'â›°ï¸'}};
        const ELEMENTS = ['Metal', 'Wood', 'Water', 'Fire', 'Earth'];
        const GENERATES = { 'Metal':'Water', 'Water':'Wood', 'Wood':'Fire', 'Fire':'Earth', 'Earth':'Metal' };
        const DESTROYS = { 'Metal':'Wood', 'Wood':'Earth', 'Earth':'Water', 'Water':'Fire', 'Fire':'Metal' };
        const LANG = {
            zh: { title: "ä¹¾å¤ Â· é¾™è—", energy: "æ°”", balance: "å®è—", my_element: "æœ¬å‘½", controls: "äº”è¡Œæµè½¬ Â· ç”Ÿç”Ÿä¸æ¯", msg_harmony: "ã€ç›¸ç”Ÿã€‘æ°”è¿åŠ èº«ï¼èƒ½é‡ +1", msg_clash: "ã€ç›¸å…‹ã€‘å…ƒæ°”å—æŸï¼èƒ½é‡ -2", msg_scale: "ã€å‰å…†ã€‘å‘ç°é¾™é³ (ç«)ï¼+0.5 Pi", msg_eye: "ã€å¤©å‘½ã€‘ç‚¹äº®é¾™çœ¼ï¼+5.0 Pi", msg_empty: "æ­¤å¤„æ˜¯ä¸€ç‰‡", element_names: {'Metal':'é‡‘åœ°', 'Wood':'æ—åœ°', 'Water':'æ°´æ³½', 'Fire':'ç„¦åœŸ', 'Earth':'è’åŸ'} },
            en: { title: "Pi: The Hidden", energy: "Chi", balance: "Pi", my_element: "Destiny", controls: "Cycles of Creation and Destruction", msg_harmony: "[Harmony] Energy Gained! +1 Chi", msg_clash: "[Clash] Energy Lost! -2 Chi", msg_scale: "[Omen] Dragon Scale (Fire) found! +0.5 Pi", msg_eye: "[Jackpot] Dragon Eye Revealed! +5.0 Pi", msg_empty: "You found ", element_names: {'Metal':'Metal Ore', 'Wood':'Forest', 'Water':'Lake', 'Fire':'Ash', 'Earth':'Barren Land'} }
        };
        const DRAGON_MAP = [[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,1,0,0,0,0,0,0,1,0,0],[0,0,1,1,0,0,0,0,1,1,0,0],[0,1,1,1,1,1,1,1,1,1,1,0],[0,1,1,2,1,1,1,1,2,1,1,0],[1,1,1,1,1,1,1,1,1,1,1,1],[1,1,0,0,1,1,1,1,0,0,1,1],[0,1,1,1,1,0,0,1,1,1,1,0],[0,0,1,1,1,0,0,1,1,1,0,0],[0,0,1,0,1,0,0,1,0,1,0,0],[0,0,1,0,0,0,0,0,0,1,0,0],[0,0,0,0,0,0,0,0,0,0,0,0]];
        const CONFIG = { gridSize: 12, gap: 1, bg: '#111', tileSize: 0 };
        let state = { energy: 15, balance: 0.00, myElement: 'Metal', mapData: [] };
        let currentLang = 'zh';
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        const msgBox = document.getElementById('message-box');
        
        const AudioSys = { ctx:null, init:function(){if(!this.ctx)this.ctx=new(window.AudioContext||window.webkitAudioContext)();if(this.ctx.state==='suspended')this.ctx.resume();}, beep:function(freq,type,dur){if(!this.ctx)this.init();const o=this.ctx.createOscillator();const g=this.ctx.createGain();o.type=type;o.frequency.setValueAtTime(freq,this.ctx.currentTime);g.gain.setValueAtTime(0.1,this.ctx.currentTime);g.gain.exponentialRampToValueAtTime(0.01,this.ctx.currentTime+dur);o.connect(g);g.connect(this.ctx.destination);o.start();o.stop(this.ctx.currentTime+dur);} };

        function init() {
            const size = Math.min(window.innerWidth, window.innerHeight) * 0.85;
            canvas.width = size; canvas.height = size;
            CONFIG.tileSize = (size - (CONFIG.gridSize + 1) * CONFIG.gap) / CONFIG.gridSize;
            rerollDestiny();
            for (let r = 0; r < CONFIG.gridSize; r++) {
                let row = [];
                for (let c = 0; c < CONFIG.gridSize; c++) {
                    const design = DRAGON_MAP[r][c];
                    let type = 'empty'; let element = ELEMENTS[Math.floor(Math.random() * 5)];
                    if (design === 1) { type = 'scale'; element = 'Fire'; } else if (design === 2) { type = 'eye'; element = 'Metal'; }
                    row.push({ explored: false, type: type, element: element });
                }
                state.mapData.push(row);
            }
            updateUI(); drawMap();
            canvas.addEventListener('click', handleInput);
            document.body.addEventListener('click', ()=>AudioSys.init(), {once:true});
        }
        function handleInput(e) {
            const rect = canvas.getBoundingClientRect();
            const col = Math.floor((e.clientX - rect.left) / (CONFIG.tileSize + CONFIG.gap));
            const row = Math.floor((e.clientY - rect.top) / (CONFIG.tileSize + CONFIG.gap));
            if (col < 0 || col >= CONFIG.gridSize || row < 0 || row >= CONFIG.gridSize) return;
            const cell = state.mapData[row][col];
            if (cell.explored) return;
            if (state.energy <= 0) { showMessage(currentLang==='zh'?"æ°”æ•°å·²å°½ï¼Œè¯·ç­‰å¾…ã€‚":"Low Chi.", '#7f8c8d'); return; }
            let feedback="", color="#fff"; const tileEl=cell.element; const myEl=state.myElement; const t=LANG[currentLang];
            if(GENERATES[tileEl]===myEl){state.energy+=1;feedback=t.msg_harmony;color="#2ecc71";AudioSys.beep(600,'sine',0.3);}
            else if(DESTROYS[tileEl]===myEl){state.energy-=1;feedback=t.msg_clash;color="#e74c3c";AudioSys.beep(150,'sawtooth',0.4);}
            else if(GENERATES[myEl]===tileEl){feedback=currentLang==='zh'?"ã€æ³„æ°”ã€‘ä»˜å‡ºèƒ½é‡ã€‚":"Chi drained.";color="#aaa";AudioSys.beep(300,'triangle',0.1);}
            else if(DESTROYS[myEl]===tileEl){feedback=currentLang==='zh'?"ã€æŒæ§ã€‘äº”è¡Œå¹³ç¨³ã€‚":"Controlled.";AudioSys.beep(400,'triangle',0.1);}
            else {feedback=currentLang==='zh'?"ã€æ¯”å’Œã€‘æ°”æ¯å¹³ç¨³ã€‚":"Neutral.";AudioSys.beep(400,'sine',0.1);}
            state.energy-=1; cell.explored=true;
            if(cell.type==='scale'){state.balance+=0.5;feedback=t.msg_scale;color="#f1c40f";AudioSys.beep(880,'square',0.2);}
            else if(cell.type==='eye'){state.balance+=5.0;feedback=t.msg_eye;color="#00b894";AudioSys.beep(1200,'square',0.5);}
            else {feedback+=`<br>${t.msg_empty} ${WUXING[tileEl].icon} ${t.element_names[tileEl]}`;}
            showMessage(feedback,color,3000); updateUI(); drawMap();
            if(Math.random()>0.85) setTimeout(rerollDestiny,1000);
        }
        function rerollDestiny(){const keys=Object.keys(WUXING);state.myElement=keys[Math.floor(Math.random()*keys.length)];updateUI();if(navigator.vibrate)navigator.vibrate([50]);}
        function drawMap(){ctx.clearRect(0,0,canvas.width,canvas.height);for(let r=0;r<CONFIG.gridSize;r++){for(let c=0;c<CONFIG.gridSize;c++){const x=c*(CONFIG.tileSize+CONFIG.gap);const y=r*(CONFIG.tileSize+CONFIG.gap);const cell=state.mapData[r][c];if(!cell.explored){ctx.fillStyle='#222';ctx.fillRect(x,y,CONFIG.tileSize,CONFIG.tileSize);ctx.strokeStyle='#333';ctx.lineWidth=1;ctx.strokeRect(x,y,CONFIG.tileSize,CONFIG.tileSize);}else{const elData=WUXING[cell.element];ctx.fillStyle=elData.color;ctx.globalAlpha=0.8;ctx.fillRect(x,y,CONFIG.tileSize,CONFIG.tileSize);ctx.globalAlpha=1.0;ctx.font='14px Arial';ctx.textAlign='center';ctx.textBaseline='middle';if(cell.type==='scale'){ctx.fillStyle='#c0392b';ctx.fillRect(x,y,CONFIG.tileSize,CONFIG.tileSize);ctx.fillStyle='gold';ctx.fillText('ğŸ²',x+CONFIG.tileSize/2,y+CONFIG.tileSize/2);}else if(cell.type==='eye'){ctx.fillStyle='#16a085';ctx.fillRect(x,y,CONFIG.tileSize,CONFIG.tileSize);ctx.fillStyle='white';ctx.fillText('ğŸ‘ï¸',x+CONFIG.tileSize/2,y+CONFIG.tileSize/2);}else{ctx.fillStyle='#000';ctx.font='10px Arial';ctx.fillText(elData.name,x+CONFIG.tileSize/2,y+CONFIG.tileSize/2);}}}}}
        function updateUI(){const myEl=WUXING[state.myElement];const elBox=document.getElementById('destiny-box');document.getElementById('my-element').innerText=`${myEl.icon} ${myEl.name}`;elBox.style.borderColor=myEl.color;elBox.style.color=myEl.color;document.getElementById('energy').innerText=state.energy;document.getElementById('balance').innerText=state.balance.toFixed(2);const t=LANG[currentLang];document.getElementById('header').innerText=t.title;}
        function toggleLanguage(){currentLang=(currentLang==='zh')?'en':'zh';updateUI();}
        let msgTimeout;function showMessage(html,color,dur=3000){msgBox.innerHTML=html;msgBox.style.borderColor=color;msgBox.style.display='block';if(msgTimeout)clearTimeout(msgTimeout);msgTimeout=setTimeout(()=>msgBox.style.display='none',dur);}
    </script>
</body>
</html>

